import sys
import os
sys.path.append(".")
sys.path.append('src')
sys.path.append('Geneformer')

# first have to tokenize the data
import anndata as ad
from geneformer import TranscriptomeTokenizer

# load my example data
# create a new file if it doesn't exist
file_name = './01_data/geneformer/human_bonemarrow_geneformer.h5ad'
if not os.path.exists(file_name):
    print("Creating new file...")
    data = ad.read_h5ad('./01_data/human_bonemarrow.h5ad')
    data = data[:,data.var['modality'] != 'ATAC'] # filtered for only scRNAseq data
    data.obs['n_counts'] = data.obs['GEX_n_counts'].copy()
    data.var['ensembl_id'] = data.var['gene_id'].copy()
    # save the new file
    data.write_h5ad(file_name)

if not os.path.exists('./01_data/geneformer/human_bonemarrow_geneformer.dataset'):
    print("Tokenizing data...")
    tk = TranscriptomeTokenizer(
        {"cell_type": "cell_type"}, 
        nproc=1,
        gene_median_file='./Geneformer/geneformer/gene_median_dictionary_gc95M.pkl',
        token_dictionary_file="./Geneformer/geneformer/token_dictionary_gc95M.pkl",
        gene_mapping_file="./Geneformer/geneformer/ensembl_mapping_dict_gc95M.pkl",
    )
    tk.tokenize_data('./01_data/geneformer/', 
                    './01_data/geneformer/', 
                    "human_bonemarrow_geneformer", 
                    file_format="h5ad")
    print("Tokenization done.")

# code from example https://huggingface.co/ctheodoris/Geneformer/blob/main/examples/extract_and_plot_cell_embeddings.ipynb
from Geneformer.geneformer import EmbExtractor

embex = EmbExtractor(
    forward_batch_size=32,
    emb_label=["cell_type"],
    labels_to_plot=["cell_type"],
    max_ncells=100000, # the actual data is just below 70k
    ) # try default
print("EmbExtractor initialized.")

# extracts embedding from input data
# input data is tokenized rank value encodings generated by Geneformer tokenizer (see tokenizing_scRNAseq_data.ipynb)
# example dataset for 30M model series: https://huggingface.co/datasets/ctheodoris/Genecorpus-30M/tree/main/example_input_files/cell_classification/disease_classification/human_dcm_hcm_nf.dataset
embs = embex.extract_embs(
    "./Geneformer/gf-20L-95M-i4096",
    "./01_data/geneformer/human_bonemarrow_geneformer.dataset",
    "./03_results/embeddings/",
    "human_bonemarrow_geneformer",
    device="cuda:1",
)
print("Embeddings extracted.")

# plot UMAP of cell embeddings
# note: scanpy umap necessarily saves figs to figures directory
embex.plot_embs(embs=embs, 
                plot_style="umap",
                output_directory="./03_results/embeddings/",  
                output_prefix="emb_plot")
print("UMAP plot saved.")